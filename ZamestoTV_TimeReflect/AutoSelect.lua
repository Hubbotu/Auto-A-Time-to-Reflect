local addonName, addon = ...

-- Define the default NPC_LIST table
local defaultNPC_LIST = {
    ["Historian Ju'pa"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},
    ["Historian Llore"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},

    -- Russian localized names
    ["Историк Ю'па"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},
    ["Историк Ллор"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},

    -- German localized names
    ["Historiker Ju'pa"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},
    ["Historiker Llore"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},

    -- French localized names
    ["Historien Ju’pa"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},
    ["Historien Llore"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},

    -- Chinese localized names
    ["历史学家吉帕"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},
    ["历史学家勒洛尔"] = {111278, 111284, 111287, 111290, 111295, 111300, 111302, 111308, 111311, 111314, 111320, 111323, 111327, 111330, 111336, 111340, 111346, 111351, 111355, 41523, 41528, 41532, 41536, 41539, 41544, 41546, 41660, 41674, 41676, 41683, 41686, 41706, 41711, 41716, 42020, 42025, 42026, 42032, 42086, 42088, 42091, 42098, 42099, 42156, 42157, 42162, 42166, 42169, 42176, 42179, 42184, 42185, 42192, 42210, 42214, 42220, 45687, 45695, 45699, 45705, 46001, 46004, 46010, 46017, 46019, 46026, 46031, 46036, 46063, 46069, 46073, 46080, 46085, 46088, 46094, 46101, 46106, 46108, 46130, 46134, 46139, 46146, 46148, 46155, 46159, 46166, 46168, 46175, 46185, 46192, 46194, 46202, 46206, 46212, 46214, 46219, 46225, 46229, 46237, 111342, 46224, 111280, 41529, 111310, 46224, 111280, 41529, 111310, 111347, 42181},
}

local NPC_LIST = defaultNPC_LIST

-- Create the frame for automatic gossip handling
local AutoGossip = CreateFrame("Frame")

-- Function to get the localized NPC name
local function GetLocalizedNPCName(npcName)
    local localizedNPCName = nil
    if GetLocale() == "ruRU" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    elseif GetLocale() == "deDE" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    elseif GetLocale() == "frFR" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    elseif GetLocale() == "zhCN" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    end
    return localizedNPCName or npcName
end

-- Function to handle gossip interaction
local function HandleGossipInteraction(_, type)
    if IsShiftKeyDown() then return end
    if type ~= Enum.PlayerInteractionType.Gossip then return end
    local npcName = GossipFrame.TitleContainer.TitleText:GetText()
    if not npcName then return end
    local gossips = NPC_LIST[npcName]
    if not gossips then
        npcName = GetLocalizedNPCName(npcName)
        gossips = NPC_LIST[npcName]
        if not gossips then return end
    end
    local options = C_GossipInfo.GetOptions()
    if not options then return end
    for _, option in ipairs(options) do
        if tContains(gossips, option.gossipOptionID) then
            C_GossipInfo.SelectOption(option.gossipOptionID)
            return
        end
    end
end

-- Set script for gossip interaction event
AutoGossip:SetScript("OnEvent", HandleGossipInteraction)
AutoGossip:RegisterEvent("PLAYER_INTERACTION_MANAGER_FRAME_SHOW")

-- Function to load saved variables
local function LoadSavedVariables()
    if AutoGossipSavedVarsonon and AutoGossipSavedVarsonon.NPC_LIST then
        NPC_LIST = AutoGossipSavedVarsonon.NPC_LIST
    end
end

-- Function to save variables
local function SaveSavedVariables()
    if not AutoGossipSavedVarsonon then
        AutoGossipSavedVarsonon = {}
    end
    AutoGossipSavedVarsonon.NPC_LIST = NPC_LIST
end

-- Function to handle player logout event
local function OnPlayerLogout()
    SaveSavedVariables()
end

-- Event registration for addon loaded and player logout
AutoGossip:RegisterEvent("ADDON_LOADED")
AutoGossip:RegisterEvent("PLAYER_LOGOUT")

-- Event handler for addon loaded and player logout
AutoGossip:SetScript("OnEvent", function(self, event, arg1)
    if event == "ADDON_LOADED" and arg1 == addonName then
        LoadSavedVariables()
        self:UnregisterEvent("ADDON_LOADED")
    elseif event == "PLAYER_LOGOUT" then
        OnPlayerLogout()
    else
        HandleGossipInteraction(event, arg1)
    end
end)