local addonName, addon = ...

-- Define the default NPC_LIST table
local defaultNPC_LIST = {
    ["Historian Ju'pa"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},
    ["Historian Llore"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},

    -- Russian localized names
    ["Историк Ю'па"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},
    ["Историк Ллор"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},

    -- German localized names
    ["Historiker Ju'pa"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},
    ["Historiker Llore"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},

    -- French localized names
    ["Historien Ju’pa"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},
    ["Historien Llore"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},

    -- Chinese localized names
    ["历史学家吉帕"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},
    ["历史学家勒洛尔"] = {46036, 42026, 46166, 46139, 45705, 41674, 46108, 111295, 45699, 46206, 46073, 41523, 46088, 111284, 46019, 41711, 46134, 46194, 42088, 41683, 41716, 46155, 42169, 46094, 45695, 46225, 42157, 41660, 111308, 46185, 41676, 41528, 46063, 46130, 42210, 45687, 111287, 42185, 111355, 42176, 111302, 46192, 46229, 41706, 111311, 46146, 46085, 111346, 46148, 111351, 42156, 42220, 41544, 41686, 46026, 46168, 42098, 42020, 42162, 111336, 46214, 111290, 42086, 46004, 42192, 46219, 111330, 111340, 41539, 46017, 41546, 111300, 42032, 42025, 41532, 46069, 46202, 41536, 42099, 42091, 46106, 111278, 111323, 111327, 46031, 42184, 42214, 46237, 46010, 46159, 42166, 111320, 46175, 46001, 111314, 42179, 46212, 111342, 46080, 46094, 46106, 46004, 46212, 46001, 46219, 46229, 46031, 42032, 46101, 46073},
}

local NPC_LIST = defaultNPC_LIST

-- Create the frame for automatic gossip handling
local AutoGossip = CreateFrame("Frame")

-- Function to get the localized NPC name
local function GetLocalizedNPCName(npcName)
    local localizedNPCName = nil
    if GetLocale() == "ruRU" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    elseif GetLocale() == "deDE" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    elseif GetLocale() == "frFR" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    elseif GetLocale() == "zhCN" then
        for name, gossips in pairs(NPC_LIST) do
            if gossips == npcName then
                localizedNPCName = name
                break
            end
        end
    end
    return localizedNPCName or npcName
end

-- Function to handle gossip interaction
local function HandleGossipInteraction(_, type)
    if IsShiftKeyDown() then return end
    if type ~= Enum.PlayerInteractionType.Gossip then return end
    local npcName = GossipFrame.TitleContainer.TitleText:GetText()
    if not npcName then return end
    local gossips = NPC_LIST[npcName]
    if not gossips then
        npcName = GetLocalizedNPCName(npcName)
        gossips = NPC_LIST[npcName]
        if not gossips then return end
    end
    local options = C_GossipInfo.GetOptions()
    if not options then return end
    for _, option in ipairs(options) do
        if tContains(gossips, option.gossipOptionID) then
            C_GossipInfo.SelectOption(option.gossipOptionID)
            return
        end
    end
end

-- Set script for gossip interaction event
AutoGossip:SetScript("OnEvent", HandleGossipInteraction)
AutoGossip:RegisterEvent("PLAYER_INTERACTION_MANAGER_FRAME_SHOW")

-- Function to load saved variables
local function LoadSavedVariables()
    if AutoGossipSavedVarsonon and AutoGossipSavedVarsonon.NPC_LIST then
        NPC_LIST = AutoGossipSavedVarsonon.NPC_LIST
    end
end

-- Function to save variables
local function SaveSavedVariables()
    if not AutoGossipSavedVarsonon then
        AutoGossipSavedVarsonon = {}
    end
    AutoGossipSavedVarsonon.NPC_LIST = NPC_LIST
end

-- Function to handle player logout event
local function OnPlayerLogout()
    SaveSavedVariables()
end

-- Event registration for addon loaded and player logout
AutoGossip:RegisterEvent("ADDON_LOADED")
AutoGossip:RegisterEvent("PLAYER_LOGOUT")

-- Event handler for addon loaded and player logout
AutoGossip:SetScript("OnEvent", function(self, event, arg1)
    if event == "ADDON_LOADED" and arg1 == addonName then
        LoadSavedVariables()
        self:UnregisterEvent("ADDON_LOADED")
    elseif event == "PLAYER_LOGOUT" then
        OnPlayerLogout()
    else
        HandleGossipInteraction(event, arg1)
    end
end)